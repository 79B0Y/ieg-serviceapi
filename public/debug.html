<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>多服务管理 API 调试台（增强版）</title>
  <style>
    :root{--bg:#1e1e1e;--panel:#252526;--panel2:#2d2d30;--border:#3c3c3c;--text:#d4d4d4;--blue:#4fc3f7;--green:#4caf50;--red:#f44336}
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:ui-monospace,Menlo,Consolas,monospace;background:var(--bg);color:var(--text)}
    .container{max-width:1450px;margin:0 auto;padding:18px}
    .header{background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:14px 16px;margin-bottom:16px;display:flex;justify-content:space-between;align-items:center}
    .header h1{color:var(--blue);font-size:18px}
    .status{padding:6px 10px;border-radius:6px;border:1px solid var(--border);font-size:12px}
    .ok{background:#1a3327;color:#9be7c4} .bad{background:#3a2222;color:#ffcdd2}
    .grid{display:grid;grid-template-columns:520px 1fr;gap:16px}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
    .panel h2{font-size:14px;color:#9cdcfe;background:var(--panel2);padding:10px 12px;border-bottom:1px solid var(--border)}
    .body{padding:12px}
    .row{display:grid;grid-template-columns:110px 1fr;gap:10px;margin-bottom:10px}
    label{color:#9cdcfe;font-size:12px;line-height:28px}
    input,select,textarea{width:100%;background:#0d1117;border:1px solid var(--border);color:var(--text);border-radius:8px;padding:8px 10px;font-size:12px}
    textarea{min-height:110px;resize:vertical}
    .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .btn{background:#0e639c;border:none;border-radius:8px;color:#fff;padding:9px 12px;font-size:12px;cursor:pointer}
    .btn:hover{background:#1177bb}
    .btn.secondary{background:#424242}.btn.secondary:hover{background:#616161}
    .btn.success{background:#2e7d32}.btn.success:hover{background:#39863d}
    .logs-toolbar{display:flex;gap:8px;align-items:center;padding:8px 10px;background:var(--panel2);border-bottom:1px solid var(--border)}
    .logs{flex:1;overflow:auto;padding:10px}
    .entry{border-left:3px solid var(--blue);background:#0b0f14;border:1px solid #22303f;margin:0 0 10px;border-radius:8px;padding:8px}
    .res{border-left-color:var(--green)} .err{border-left-color:var(--red)} .ws{border-left-color:#b388ff}
    .meta{display:flex;gap:10px;flex-wrap:wrap;font-size:11px;color:#9aa7b0;margin-bottom:6px}
    .kv{display:grid;grid-template-columns:110px 1fr;gap:6px;font-size:12px;margin:6px 0}
    details{background:#0d1117;border:1px solid #233043;border-radius:6px;margin-top:6px}
    summary{cursor:pointer;padding:6px 10px;color:#a5d6ff}
    pre{margin:0;padding:10px 12px;white-space:pre-wrap;word-break:break-word;font-size:12px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>多服务管理 API 调试台</h1>
    <div id="wsState" class="status bad">WS 未连接</div>
  </div>

  <div class="grid">
    <!-- 左：请求构建器 -->
    <div class="panel">
      <h2>请求构建器</h2>
      <div class="body">
        <div class="row">
          <label>API 基址</label>
          <input id="apiBase" />
        </div>
        <div class="row">
          <label>方法</label>
          <select id="method"><option>GET</option><option>POST</option><option>PUT</option><option>DELETE</option></select>
        </div>
        <div class="row">
          <label>端点</label>
          <input id="endpoint" placeholder="/services 或 /services/hass/status" />
        </div>
        <div class="row">
          <label>Headers (JSON)</label>
          <textarea id="headers" spellcheck="false" placeholder='{"Content-Type":"application/json"}'></textarea>
        </div>
        <div class="row">
          <label>Body (JSON)</label>
          <textarea id="body" spellcheck="false" placeholder='{"timeout":30000,"params":{"json":true}}'></textarea>
        </div>
        <div class="btns">
          <button class="btn success" id="sendBtn">发送请求</button>
          <button class="btn secondary" id="clearBtn">清空日志</button>
          <button class="btn secondary" id="exportBtn">导出日志</button>
        </div>
        <div style="margin-top:10px;font-size:12px;color:#aaa">
          说明：默认基址为 <b>当前页面 origin + /ieg-serviceapi</b>（即 3008 端口下的新前缀）。
        </div>
      </div>
    </div>

    <!-- 右：日志面板 -->
    <div class="panel" style="min-height:540px">
      <div class="logs-toolbar">
        <input id="search" placeholder="搜索（URL/状态码/内容）" style="flex:1;padding:6px 10px" />
        <label style="font-size:12px"><input type="checkbox" id="autoScroll" checked> 自动滚动</label>
        <label style="font-size:12px"><input type="checkbox" id="pretty" checked> JSON美化</label>
      </div>
      <div id="logs" class="logs"></div>
    </div>
  </div>
</div>

<script>
(() => {
  const $ = id=>document.getElementById(id);
  const fmt = t=>new Date(t).toLocaleString();
  const tryJ = (t,f)=>{try{return JSON.parse(t)}catch{return f}};
  const pretty = x=>{try{return JSON.stringify(typeof x==='string'?JSON.parse(x):x,null,2)}catch{return typeof x==='string'?x:JSON.stringify(x,null,2)}};

  const state={logs:[], ws:null};

  function add(kind, meta={}, blocks=[]){ state.logs.push({kind,when:Date.now(),meta,blocks}); render(); }
  function render(){
    const q = $('search').value.trim().toLowerCase();
    const beaut = $('pretty').checked; const box = $('logs'); box.innerHTML='';
    for(const e of state.logs){
      const raw = JSON.stringify(e).toLowerCase(); if(q && !raw.includes(q)) continue;
      const wrap = document.createElement('div'); wrap.className='entry '+(e.kind||'req');
      const meta = document.createElement('div'); meta.className='meta';
      if(e.meta.time) meta.appendChild(span(`[${fmt(e.meta.time)}]`));
      if(e.meta.method) meta.appendChild(span(e.meta.method));
      if(e.meta.url) meta.appendChild(span(e.meta.url));
      if(e.meta.status!=null) meta.appendChild(span(String(e.meta.status)));
      if(e.meta.ms!=null) meta.appendChild(span(`${e.meta.ms}ms`));
      if(e.meta.size!=null) meta.appendChild(span(`${e.meta.size}B`));
      wrap.appendChild(meta);
      for(const b of e.blocks){
        const d=document.createElement('details'); const s=document.createElement('summary'); s.textContent=b.title;
        const pre=document.createElement('pre'); pre.textContent= beaut? pretty(b.content): (typeof b.content==='string'?b.content:JSON.stringify(b.content));
        d.append(s,pre); wrap.appendChild(d);
      }
      box.appendChild(wrap);
    }
    if($('autoScroll').checked) box.scrollTop = box.scrollHeight;
  }
  const span=t=>{const s=document.createElement('span'); s.textContent=t; return s};

  // ---- WS (接收后端广播的 http_request/script_* 等事件) ----
  function connectWS(){
    const proto = location.protocol==='https:'?'wss:':'ws:'; const url = `${proto}//${location.host}`;
    try{
      state.ws = new WebSocket(url);
      state.ws.onopen = ()=> setWS(true);
      state.ws.onclose= ()=> { setWS(false); setTimeout(connectWS, 3000); };
      state.ws.onerror= ()=> setWS(false);
      state.ws.onmessage = ev => {
        try{
          const msg = JSON.parse(ev.data);
          if(msg.type==='http_request'){
            add('ws',{time:Date.now()},[{title:'HTTP 请求（WS广播）',content:{method:msg.method,url:msg.url,headers:msg.headers,body:msg.body}}]);
          }else{
            add('ws',{time:Date.now()},[{title:`WS: ${msg.type||'message'}`,content:msg}]);
          }
        }catch{ add('ws',{time:Date.now()},[{title:'WS 原始消息',content:ev.data}]); }
      };
    }catch{}
  }
  function setWS(ok){ const el=$('wsState'); el.textContent= ok?'WS 已连接':'WS 未连接'; el.className='status '+(ok?'ok':'bad'); }

  // ---- 发送请求：把“具体 HTTP 请求”与“响应”都写入日志 ----
  async function send(){
    const base = ($('apiBase').value || (window.location.origin + '/ieg-serviceapi')).replace(/\/+$/,'');
    const m = $('method').value; const ep = $('endpoint').value.trim() || '/health';
    const url = base + (ep.startsWith('/')?ep:'/'+ep);
    const headers = tryJ($('headers').value||'{}',{});
    if(!headers['Content-Type'] && m!=='GET') headers['Content-Type']='application/json';
    let bodyText = $('body').value.trim();
    if(m!=='GET' && bodyText){ try{ JSON.parse(bodyText) }catch(e){ add('err',{time:Date.now()},[{title:'无效的JSON',content:String(e)}]); return; } }

    const started = performance.now();
    add('req',{time:Date.now(),method:m,url},[{title:'请求头',content:headers},{title:'请求体',content:bodyText||null}]);

    try{
      const res = await fetch(url,{method:m,headers,body:(m==='GET'?undefined:(bodyText||undefined))});
      const ms = Math.round(performance.now()-started);
      const rh={}; res.headers.forEach((v,k)=>rh[k]=v);
      const text = await res.text(); let data=text; if((rh['content-type']||'').includes('application/json')){ try{data=JSON.parse(text)}catch{} }
      add(res.ok?'res':'err',{time:Date.now(),method:m,url,status:res.status,ms,size:text.length},[{title:'响应头',content:rh},{title:'响应体',content:data}]);
    }catch(e){ add('err',{time:Date.now(),method:m,url},[{title:'请求失败',content:String(e)}]); }

    // 记忆
    localStorage.setItem('dbg.base', $('apiBase').value);
    localStorage.setItem('dbg.m', $('method').value);
    localStorage.setItem('dbg.e', $('endpoint').value);
    localStorage.setItem('dbg.h', $('headers').value);
    localStorage.setItem('dbg.b', $('body').value);
  }

  function init(){
    $('apiBase').value = localStorage.getItem('dbg.base') || (window.location.origin + '/ieg-serviceapi');
    $('method').value  = localStorage.getItem('dbg.m') || 'GET';
    $('endpoint').value= localStorage.getItem('dbg.e') || '/health';
    $('headers').value = localStorage.getItem('dbg.h') || '{"Content-Type":"application/json"}';
    $('body').value    = localStorage.getItem('dbg.b') || '';

    $('sendBtn').onclick = send;
    $('clearBtn').onclick = ()=>{ state.logs=[]; render(); };
    $('exportBtn').onclick= ()=>{ const blob=new Blob([JSON.stringify(state.logs,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='api-debug-logs.json'; a.click(); };
    $('search').oninput = render;
    connectWS();
  }
  init();
})();
</script>
</body>
</html>
