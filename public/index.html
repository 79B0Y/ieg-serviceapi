<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Home Assistant 服务管理</title>
  <style>
    :root{
      --primary:#2196F3;--success:#4CAF50;--error:#f44336;--warn:#ff9800;
      --bg:#f5f5f5;--card:#fff;--text:#333;--sub:#666;--border:#ddd;
      --radius:10px;--shadow:0 2px 10px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    .header{display:flex;align-items:center;justify-content:space-between;background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px 20px;margin-bottom:16px}
    .header h1{color:var(--primary);font-size:22px}
    .conn{display:flex;align-items:center;gap:10px;padding:8px 14px;border-radius:20px;border:1px solid rgba(0,0,0,.08)}
    .conn.ok{background:rgba(76,175,80,.08);color:var(--success);border-color:rgba(76,175,80,.3)}
    .conn.bad{background:rgba(244,67,54,.08);color:var(--error);border-color:rgba(244,67,54,.3)}

    .grid{display:grid;grid-template-columns:360px 1fr;gap:16px}
    .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px}
    h2{font-size:16px;margin-bottom:12px}

    .form-item{margin-bottom:12px}
    label{display:block;font-size:12px;color:var(--sub);margin-bottom:6px}
    select,input{width:100%;padding:10px;border:1px solid var(--border);border-radius:8px}

    .status-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0 16px}
    .status-box{border:1px solid var(--border);border-radius:8px;padding:10px;background:rgba(0,0,0,.02)}
    .status-box h3{font-size:12px;color:var(--sub);margin-bottom:6px;text-transform:uppercase;letter-spacing:.4px}
    .val{font-weight:600}
    .green{color:var(--success)}.red{color:var(--error)}.amber{color:var(--warn)}

    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px}
    .btn{border:0;border-radius:10px;color:#fff;padding:12px 14px;font-weight:600;cursor:pointer}
    .btn.primary{background:var(--primary)}
    .btn.success{background:var(--success)}
    .btn.warn{background:var(--warn)}
    .btn.gray{background:#6c757d}
    .btn.danger{background:var(--error)}

    .terminal{height:430px;overflow:auto;background:#111827;color:#e5e7eb;border-radius:10px;padding:14px;font-family:ui-monospace,Consolas,Menlo,monospace}
    .log{border-left:3px solid transparent;margin-bottom:10px;padding-left:10px}
    .log.stdout{border-color:#4CAF50}
    .log.stderr{border-color:#f44336;color:#ff7676}
    .log.info{border-color:#2196F3;color:#90caf9}
    .log .ts{color:#9ca3af;font-size:12px;margin-right:6px}

    .clear{float:right;border:1px solid #555;background:transparent;color:#e5e7eb;border-radius:6px;padding:6px 10px;cursor:pointer}

    @media (max-width: 900px){.grid{grid-template-columns:1fr}.terminal{height:320px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Home Assistant 服务管理</h1>
      <div id="conn" class="conn bad">WS 未连接</div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="form-item">
          <label>选择服务</label>
          <select id="serviceSelector" onchange="app.switchService()">
            <option value="hass">Home Assistant Core</option>
          </select>
        </div>

        <h2>服务状态</h2>
        <div id="alerts"></div>
        <div class="status-grid">
          <div class="status-box"><h3>运行状态</h3><div id="runStatus" class="val">检查中...</div></div>
          <div class="status-box"><h3>安装状态</h3><div id="installStatus" class="val">检查中...</div></div>
          <div class="status-box"><h3>当前版本</h3><div id="currentVersion" class="val">获取中...</div></div>
          <div class="status-box"><h3>HTTP端口</h3><div id="httpStatus" class="val">检查中...</div></div>
        </div>

        <h2>控制面板</h2>
        <div class="controls">
          <button class="btn primary" onclick="app.executeScript('autocheck')">状态检查</button>
          <button class="btn success" onclick="app.executeScript('start')">启动服务</button>
          <button class="btn warn" onclick="app.executeScript('stop')">停止服务</button>
          <button class="btn gray" onclick="app.executeScript('backup')">创建备份</button>
        </div>
      </div>

      <div class="card">
        <h2>执行日志 <button class="clear" onclick="app.clearTerminal()">清除日志</button></h2>
        <div id="terminal" class="terminal"></div>
      </div>
    </div>
  </div>

<script>
(function(){
  class App{
    constructor(){
      // ✅ 统一新 API 前缀：使用当前页面的 host + /ieg-serviceapi（端口即 3008）
      this.apiBase = window.location.origin + '/ieg-serviceapi';
      this.currentService = 'hass';
      this.term = document.getElementById('terminal');
      this.connEl = document.getElementById('conn');
      this.ws = null;
      this.initWS();
      this.loadServiceStatus();
      setInterval(()=>this.loadServiceStatus(), 30000);
    }

    switchService(){
      const sel = document.getElementById('serviceSelector');
      this.currentService = sel.value || 'hass';
      this.addLog(`切换到服务: ${this.currentService}`, 'info');
      this.loadServiceStatus();
    }

    async loadServiceStatus(){
      // ✅ 正确路由：GET /ieg-serviceapi/services/:id/status
      const url = `${this.apiBase}/services/${this.currentService}/status`;
      this.logHttp('GET', url);
      try{
        const resp = await fetch(url);
        const text = await resp.text();
        this.logHttpResp(resp, text);
        const data = this.safeParse(text, {});
        this.renderStatus(data);
      }catch(e){
        this.addLog('获取状态失败: '+e.message, 'stderr');
      }
    }

    renderStatus(data){
      const set = (id, val, cls='')=>{ const el=document.getElementById(id); el.textContent=val; el.className='val '+cls };
      const run = (data.run||data.status||'unknown');
      const install = data.install||'unknown';
      const version = data.current_version||data.version||'unknown';
      const http = (data.config&&data.config.http_port)? String(data.config.http_port): (data.http_available? '可用':'不可用');
      set('runStatus', run, run==='running'?'green':(run==='starting'?'amber':'red'));
      set('installStatus', install==='success'?'已安装':String(install), install==='success'?'green':'red');
      set('currentVersion', version);
      set('httpStatus', http, /可用|^\d+$/.test(http)?'green':'red');
    }

    async executeScript(script){
      // ✅ 正确路由：POST /ieg-serviceapi/services/:id/execute/:script
      const url = `${this.apiBase}/services/${this.currentService}/execute/${script}`;
      const body = JSON.stringify({params:{},timeout:60000});
      this.logHttp('POST', url, {'Content-Type':'application/json'}, body);
      try{
        const resp = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body});
        const text = await resp.text();
        this.logHttpResp(resp, text);
        if(!resp.ok){ this.addLog(`执行${script}失败: HTTP ${resp.status}`, 'stderr'); }
      }catch(e){ this.addLog(`执行${script}失败: ${e.message}`,'stderr'); }
    }

    // —— 日志：具体 HTTP 请求/响应 ——
    logHttp(method, url, headers={}, body=null){
      this.addLog(`请求: ${method} ${url}`, 'info');
      this.addLog(JSON.stringify({headers,body},null,2),'stdout');
    }
    logHttpResp(resp, raw){
      const headers=Object.fromEntries(resp.headers.entries());
      let data = raw; if((headers['content-type']||'').includes('application/json')){ try{data=JSON.parse(raw)}catch{} }
      this.addLog(`响应: ${resp.status} ${resp.statusText}`,(resp.ok?'stdout':'stderr'));
      this.addLog(JSON.stringify({headers,data},null,2),(resp.ok?'stdout':'stderr'));
    }

    // —— WebSocket ——
    initWS(){
      const proto = location.protocol==='https:'?'wss:':'ws:';
      const url = `${proto}//${location.host}`;
      try{
        this.ws = new WebSocket(url);
        this.ws.onopen = ()=>this.setWS(true);
        this.ws.onclose= ()=>this.setWS(false);
        this.ws.onerror= ()=>this.setWS(false);
        this.ws.onmessage=(ev)=>{
          try{
            const msg=JSON.parse(ev.data);
            this.handleWS(msg);
          }catch{ this.addLog('WS: '+ev.data,'info'); }
        };
      }catch{ this.setWS(false); }
    }
    setWS(ok){ this.connEl.textContent = ok?'WS 已连接':'WS 未连接'; this.connEl.className='conn '+(ok?'ok':'bad'); }
    handleWS(m){
      if(m.type==='script_output'){ this.addLog(m.data, m.output_type==='stderr'?'stderr':'stdout'); }
      else if(m.type==='script_start'||m.type==='script_complete'||m.type==='script_error'){
        this.addLog(`[${m.type}] ${m.service}/${m.script}`, 'info');
      }
    }

    // —— 终端 UI ——
    addLog(text, level='stdout'){
      const line=document.createElement('div'); line.className='log '+level; line.innerHTML=`<span class="ts">[${new Date().toLocaleTimeString()}]</span>${this.escape(text)}`;
      this.term.appendChild(line); this.term.scrollTop=this.term.scrollHeight;
    }
    clearTerminal(){ this.term.innerHTML=''; }
    escape(s){ return String(s).replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])) }
    safeParse(t,d){ try{return JSON.parse(t)}catch{return d} }
  }
  window.app = new App();
})();
</script>
</body>
</html>
